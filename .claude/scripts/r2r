#!/usr/bin/env bash
# R2R CLI - Main entry point
# Routes commands to modular scripts

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Show help
show_help() {
    cat << EOF
R2R CLI - Modular Command Interface

USAGE:
    r2r <command> [options] <arguments>

CORE COMMANDS:
    search <query> [options]            Hybrid search (semantic + fulltext)
    rag <query> [options]               RAG query with generation
    agent <query> [options]             Multi-turn agent with tools

MANAGEMENT COMMANDS:
    docs <action> [args]                Document management (14 commands)
    collections <action> [args]         Collection management (6 commands)
    conversation <action> [args]        Conversation management (5 commands)
    graph <action> [args]               Knowledge graph operations (20 commands)
    analytics <action> [args]           System analytics (3 commands)

COMMON FLAGS (GNU-style):
    --limit, -l <num>                   Number of results (default varies by command)
    --quiet, -q                         Minimal output (one line)
    --json                              Pretty-printed JSON output
    --verbose, -v                       Full details with metadata

COMMAND-SPECIFIC FLAGS:
    Search:  --filter/-f, --strategy/-s, --graph/-g, --collection/-c
    RAG:     --max-tokens/-t, --filter/-f, --graph/-g, --show-sources
    Agent:   --mode/-m, --conversation/-c, --thinking, --show-tools

EXAMPLES:
    # Search with flags
    r2r search "machine learning" --limit 5
    r2r search "AI" -l 10 -q                        # short forms
    r2r search "transformers" --filter category=tech
    r2r search "RAG" --graph --collection abc123

    # RAG with options
    r2r rag "Explain transformers" --max-tokens 8000
    r2r rag "What is R2R?" -t 4000 --show-sources   # short forms

    # Agent modes
    r2r agent "What is DeepSeek R1?" --mode research
    r2r agent "Analyze this" -m research --thinking
    r2r agent "Follow up" --conversation abc123

    # Management commands
    r2r docs list --limit 20
    r2r collections create "My Collection" -q
    r2r graph entities abc123 --limit 50
    r2r analytics system

For detailed help on each command:
    r2r <command> help

    Examples:
    r2r docs help
    r2r collections help
    r2r graph help
EOF
}

# Main command dispatcher
COMMAND="${1:-help}"

case "$COMMAND" in
    search)
        shift
        "${SCRIPT_DIR}/commands/search.sh" "$@"
        ;;

    rag)
        shift
        "${SCRIPT_DIR}/commands/rag.sh" "$@"
        ;;

    agent)
        shift
        "${SCRIPT_DIR}/commands/agent.sh" "$@"
        ;;

    docs|documents)
        shift
        "${SCRIPT_DIR}/commands/docs.sh" "$@"
        ;;

    collections|coll)
        shift
        "${SCRIPT_DIR}/commands/collections.sh" "$@"
        ;;

    conversation|conv)
        shift
        "${SCRIPT_DIR}/commands/conversation.sh" "$@"
        ;;

    graph|kg)
        shift
        "${SCRIPT_DIR}/commands/graph.sh" "$@"
        ;;

    analytics|stats)
        shift
        "${SCRIPT_DIR}/commands/analytics.sh" "$@"
        ;;

    help|--help|-h)
        show_help
        ;;

    *)
        echo "Error: Unknown command '$COMMAND'" >&2
        echo "Run 'r2r help' for usage information" >&2
        exit 1
        ;;
esac
