name: Gemini Documentation Review

on:
  pull_request:
    paths:
      - 'docs/**/*.md'
      - '.claude/**/*.md'
      - 'README.md'
      - 'CLAUDE.md'
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  review-docs:
    name: Review Documentation Changes
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed documentation files
        id: get_diff
        shell: bash
        run: |
          # Fetch PR branches
          git fetch origin "${{ github.event.pull_request.head.ref }}"
          git fetch origin "${{ github.event.pull_request.base.ref }}"
          git checkout "${{ github.event.pull_request.head.ref }}"
          
          # Generate diff for documentation files only
          git diff "origin/${{ github.event.pull_request.base.ref }}" \
            -- '*.md' ':!node_modules' ':!.github' > diff.txt
          
          # Store diff in output
          {
            echo "pull_request_diff<<EOF"
            cat diff.txt
            echo 'EOF'
          } >> $GITHUB_OUTPUT
          
          # Count changed files
          CHANGED_FILES=$(git diff --name-only "origin/${{ github.event.pull_request.base.ref }}" -- '*.md' ':!node_modules' ':!.github' | wc -l)
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "üìù Changed documentation files: $CHANGED_FILES"

      - name: Review documentation with Gemini AI
        if: steps.get_diff.outputs.changed_files > 0
        uses: rubensflinco/gemini-code-review-action@1.0.5
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          github_repository: ${{ github.repository }}
          github_pull_request_number: ${{ github.event.pull_request.number }}
          git_commit_hash: ${{ github.event.pull_request.head.sha }}
          model: "gemini-1.5-pro-latest"
          pull_request_diff: ${{ steps.get_diff.outputs.pull_request_diff }}
          pull_request_chunk_size: "4000"
          extra_prompt: |
            –¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–≤—å—é–µ—Ä —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω–æ–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ r2r-fastmcp.
            
            –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê:
            - –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (–ù–ï –∫–æ–¥–æ–≤–∞—è –±–∞–∑–∞) –¥–ª—è —Ç—Ä–µ—Ö AI-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π: R2R v3, FastMCP 2.x, Claude Code
            - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ —Å –∞–Ω–≥–ª–∏–π—Å–∫–∏–º–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ —Ç–µ—Ä–º–∏–Ω–∞–º–∏
            - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: docs/r2r/, docs/fastmcp/, docs/claude_code/
            - Bash —Å–∫—Ä–∏–ø—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ .claude/scripts/
            - –ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã: 01-NN-section-name.md
            
            –ö–†–ò–¢–ï–†–ò–ò –ü–†–û–í–ï–†–ö–ò:
            
            1. üîç –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï –°–¢–ê–ù–î–ê–†–¢–ê–ú:
               - –§–∞–π–ª—ã —Å–ª–µ–¥—É—é—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—É NN-section-name.md
               - H2 –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç —ç–º–æ–¥–∑–∏ (üéØ, üìÅ, üîç, ‚öôÔ∏è, üìö, üîó, ‚ö†Ô∏è, ‚úÖ, ‚ùå)
               - –ö–æ–¥ –±–ª–æ–∫–∏ –∏–º–µ—é—Ç —É–∫–∞–∑–∞–Ω–∏–µ —è–∑—ã–∫–∞ (```bash, ```python, ```json)
               - –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ (./file.md)
            
            2. üìö –ê–ö–¢–£–ê–õ–¨–ù–û–°–¢–¨ –ò –ü–û–õ–ù–û–¢–ê:
               - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–∫—É—â–∏–º –≤–µ—Ä—Å–∏—è–º (R2R v3, FastMCP 2.x, Claude Code 1.0.58+)
               - –í—Å–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω—ã –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã
               - API endpoints –∞–∫—Ç—É–∞–ª—å–Ω—ã (–ø—Ä–æ–≤–µ—Ä—å /v3/ –≤–º–µ—Å—Ç–æ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö /v2/)
               - –£–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤–µ—Ä—Å–∏–π –±–∏–±–ª–∏–æ—Ç–µ–∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
            
            3. üö´ –ü–†–û–¢–ò–í–û–†–ï–ß–ò–Ø –ò –û–®–ò–ë–ö–ò:
               - –ù–µ—Ç –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
               - –ö–æ–º–∞–Ω–¥—ã bash —Å–∫—Ä–∏–ø—Ç–æ–≤ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –≤ docs/
               - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã API —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
               - –°—Å—ã–ª–∫–∏ –Ω–∞ –¥—Ä—É–≥–∏–µ —Ä–∞–∑–¥–µ–ª—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
            
            4. ‚úçÔ∏è –ì–†–ê–ú–û–¢–ù–û–°–¢–¨ –ò –°–¢–ò–õ–¨:
               - –†—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç –±–µ–∑ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
               - –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–∞—è —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è (RAG, –Ω–µ –†–ê–ì; API, –Ω–µ –ê–ü–ò)
               - –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π —Å—Ç–∏–ª—å –∫–æ–¥–∞ (4 –ø—Ä–æ–±–µ–ª–∞ –¥–ª—è Python, 2 –¥–ª—è JSON/YAML)
               - –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –≤ –∫–æ–¥–µ
            
            5. üèóÔ∏è –°–¢–†–£–ö–¢–£–†–ê –ò –ù–ê–í–ò–ì–ê–¶–ò–Ø:
               - README.md –æ–±–Ω–æ–≤–ª–µ–Ω –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
               - Table of contents –∞–∫—Ç—É–∞–ª–µ–Ω
               - –ù—É–º–µ—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞
               - –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            
            6. ‚ö†Ô∏è –°–ü–ï–¶–ò–§–ò–ß–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
               - –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å package.json, requirements.txt, build —Ñ–∞–π–ª–æ–≤
               - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è vanilla search strategy (hyde/rag_fusion –ù–ï —Ä–∞–±–æ—Ç–∞—é—Ç)
               - –ü—Ä–∏–º–µ—Ä—ã curl –∏—Å–ø–æ–ª—å–∑—É—é—Ç source .claude/config/.env
               - –£–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è hybrid search –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            
            –§–û–†–ú–ê–¢ –†–ï–í–¨–Æ:
            - –°–≥—Ä—É–ø–ø–∏—Ä—É–π –∑–∞–º–µ—á–∞–Ω–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –≤—ã—à–µ
            - –£–∫–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ —Ñ–∞–π–ª—ã
            - –î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–µ—Ñ–∏–∫—Å üî¥
            - –î–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–µ—Ñ–∏–∫—Å üü°
            - –î–ª—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–µ—Ñ–∏–∫—Å üü¢
            - –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
            
            –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º, –∫—Ä–∞—Ç–∫–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ —ç—Ç–æ.
          log_level: "INFO"

      - name: Summary
        if: always()
        run: |
          echo "## üìä Documentation Review Summary"
          echo ""
          echo "Changed files: ${{ steps.get_diff.outputs.changed_files }}"
          echo "PR: #${{ github.event.pull_request.number }}"
          echo "Commit: ${{ github.event.pull_request.head.sha }}"
          echo ""
          echo "‚úÖ Gemini AI review completed"
