name: Gemini Documentation Review

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'docs/**/*.md'
      - '.claude/**/*.md'
      - 'CLAUDE.md'
      - 'README.md'

jobs:
  review-docs:
    name: Review Documentation Changes
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get changed markdown files
        id: changed-files
        run: |
          # Get list of changed .md files
          git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.md$' > changed_files.txt || true
          
          if [ -s changed_files.txt ]; then
            echo "üìù Changed documentation files: $(wc -l < changed_files.txt)"
            cat changed_files.txt
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "No markdown files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup Python
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          pip install google-generativeai requests
      
      - name: Create review script
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          cat > review_script.py << 'EOF'
          import os
          import sys
          import google.generativeai as genai
          
          api_key = os.environ.get('GEMINI_API_KEY')
          if not api_key:
              print("‚ùå GEMINI_API_KEY secret not configured")
              sys.exit(1)
          
          # Configure Gemini API (AI Studio, not Vertex AI)
          genai.configure(api_key=api_key)
          model = genai.GenerativeModel('gemini-1.5-flash')
          
          # Read project context from CLAUDE.md
          project_context = ""
          try:
              with open('CLAUDE.md', 'r', encoding='utf-8') as f:
                  content = f.read()
                  # Extract project overview
                  if '## üéØ –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞' in content:
                      start = content.find('## üéØ –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞')
                      end = content.find('## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞')
                      if end > start:
                          project_context = content[start:end]
                  
                  # Add style guidelines
                  if '## ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏' in content:
                      start = content.find('## ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏')
                      end = content.find('##', start + 10)
                      if end > start:
                          project_context += "\n\n" + content[start:end if end != -1 else len(content)]
          except Exception as e:
              print(f"‚ö†Ô∏è  Could not read CLAUDE.md: {e}")
          
          # Read changed files
          with open('changed_files.txt', 'r') as f:
              changed_files = [line.strip() for line in f if line.strip()]
          
          if not changed_files:
              print("‚úÖ No documentation files to review")
              sys.exit(0)
          
          print(f"üìù Reviewing {len(changed_files)} files...")
          
          reviews = []
          
          for filepath in changed_files:
              try:
                  with open(filepath, 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  # Determine file category
                  file_category = "general"
                  if "/r2r/" in filepath:
                      file_category = "R2R v3 documentation"
                  elif "/fastmcp/" in filepath:
                      file_category = "FastMCP 2.x documentation"
                  elif "/claude_code/" in filepath:
                      file_category = "Claude Code 1.0.58+ documentation"
                  elif "/.claude/" in filepath:
                      file_category = "R2R integration (commands/skills/agents)"
                  
                  # Build prompt safely
                  prompt_lines = [
                      "–í—ã - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Ä–µ—Ü–µ–Ω–∑–µ–Ω—Ç —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è AI-–ø—Ä–æ–µ–∫—Ç–æ–≤.",
                      "",
                      "–ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê:",
                      project_context or "–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è-only —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è R2R v3, FastMCP 2.x, Claude Code 1.0.58+",
                      "",
                      "–í–ê–ñ–ù–û: –≠—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è-only —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π. –ù–∏–∫–∞–∫–æ–≥–æ –∫–æ–¥–∞ –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏/—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.",
                      "",
                      f"–§–∞–π–ª: {filepath}",
                      f"–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {file_category}",
                      "",
                      "–ü–†–û–í–ï–†–¨–¢–ï:",
                      "1. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å API –∏ –ø—Ä–∏–º–µ—Ä–æ–≤",
                      "2. –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏ (—Ä—É—Å—Å–∫–∏–π + –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã)",
                      "3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å —ç–º–æ–¥–∑–∏ –≤ H2 –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö",
                      "4. –ü–æ–ª–Ω–æ—Ç–∞ –∏ —è—Å–Ω–æ—Å—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–π",
                      "5. –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞ –∏ —Å—Ç–∏–ª—å",
                      "6. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ CLAUDE.md –∫–æ–Ω–≤–µ–Ω—Ü–∏—è–º",
                      "",
                      "–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:",
                      "### ‚úÖ –ß—Ç–æ —Ö–æ—Ä–æ—à–æ",
                      "### ‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è", 
                      "### ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏",
                      "### üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏",
                      "### üìä –û—Ü–µ–Ω–∫–∞: X/10",
                      "",
                      "---",
                      "–°–û–î–ï–†–ñ–ò–ú–û–ï –§–ê–ô–õ–ê:",
                      content[:4000]  # Limit content for API
                  ]
                  
                  prompt = "\n".join(prompt_lines)
                  
                  response = model.generate_content(prompt)
                  reviews.append(f"## üìÑ {filepath}\n\n{response.text}\n\n---\n")
                  
              except Exception as e:
                  reviews.append(f"## üìÑ {filepath}\n\n‚ùå **–û—à–∏–±–∫–∞**: {str(e)}\n\n---\n")
          
          # Write review
          with open('review_output.md', 'w', encoding='utf-8') as f:
              f.write("# ü§ñ Gemini Documentation Review\n\n")
              f.write(f"**–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:** {len(changed_files)}\n\n")
              f.write("---\n\n")
              f.write('\n'.join(reviews))
              f.write("\n---\n\n")
              f.write("*–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ–±–∑–æ—Ä –æ—Ç Gemini AI*\n")
          
          # Print summary
          print("\nüìä Review completed successfully")
          EOF

      - name: Run review
        if: steps.changed-files.outputs.has_changes == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python3 review_script.py

      - name: Post review as comment
        if: steps.changed-files.outputs.has_changes == 'true' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            if (!fs.existsSync('review_output.md')) {
              console.log('No review output found');
              return;
            }
            
            const review = fs.readFileSync('review_output.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: review
            });